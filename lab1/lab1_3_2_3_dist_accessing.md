#### 硬盘访问概述

bootloader 让 CPU 进入保护模式后，下一步的工作就是从硬盘上加载并运行 OS。考虑到实现的简单性，bootloader 的访问硬盘都是 LBA 模式的 PIO（Program IO）方式，即所有的 IO 操作是通过 CPU 访问硬盘的 IO 地址寄存器完成。

一般主板有 2 个 IDE 通道，每个通道可以接 2 个 IDE 硬盘。访问第一个硬盘的扇区可设置 IO 地址寄存器 0x1f0-0x1f7 实现的，具体参数见下表。一般第一个 IDE 通道通过访问 IO 地址 0x1f0-0x1f7 来实现，第二个 IDE 通道通过访问 0x170-0x17f 实现。每个通道的主从盘的选择通过第 6 个 IO 偏移地址寄存器来设置。

表一 磁盘 IO 地址和对应功能

<table>
<tr><td>IO地址</td><td>功能</td></tr>
<tr><td>0x1f0</td><td>读数据，当0x1f7不为忙状态时，可以读。</td></tr>
<tr><td>0x1f2</td><td>要读写的扇区数，每次读写前，你需要表明你要读写几个扇区。最小是1个扇区</td></tr>
<tr><td>0x1f3</td><td>如果是LBA模式，就是LBA参数的0-7位</td></tr>
<tr><td>0x1f4</td><td>如果是LBA模式，就是LBA参数的8-15位</td></tr>
<tr><td>0x1f5</td><td>如果是LBA模式，就是LBA参数的16-23位</td></tr>
<tr><td>0x1f6</td><td>第0~3位：如果是LBA模式就是24-27位     第4位：为0主盘；为1从盘</td></tr>
第6位：为1=LBA模式；0 = CHS模式        第7位和第5位必须为1</td></tr>
<tr><td>0x1f7</td><td>状态和命令寄存器。操作时先给命令，再读取，如果不是忙状态就从0x1f0端口读数据</td></tr>
</table>

当前 硬盘数据是储存到硬盘扇区中，一个扇区大小为 512 字节。读一个扇区的流程（可参看 boot/bootmain.c 中的 readsect 函数实现）大致如下：

1. 等待磁盘准备好
2. 发出读取扇区的命令
3. 等待磁盘准备好
4. 把磁盘扇区数据读到指定内存
